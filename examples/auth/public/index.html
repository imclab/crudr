<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="http://localhost:4000/client.js"></script>
    
    <script>
		// variables
		var chat, model, el;
		// CHANGE THIS with your own backend...
		var backend = "demo_demo_chat";
		var auth =  {
			key : "37fff53aeb6094f55b0328082aaf1de7", 
			//secret : "$2a$10$lBY2DZ4l/Goow9BnznPLBuTTjM8nlOGHXgcZjO59v86uMntYIzjQy", 
			log : true
		};
		//
		function setupEvents(){
			
			chat.addEventListener(backend +':create', function( e ) {
				//console.log("create");
				var data = e.response.data;
				$("#chat").append("<li>"+data+"</li>");
			}, false);
			chat.addEventListener(backend +':read', function( e ) {
				//foreach
				//console.log("read");
				var list = e.response;
				for(i in list){
					$("#chat").append("<li>"+list[i].data+"</li>");
				}
				
			}, false);
			
		}
        
		function setupTriggers(){
			
			$(".send").click(function(){
				var text = $(".message").val();
				// add to the chat
				$("#chat").append("<li>"+text+"</li>");
				// sync with crudr
				var req = {
					method: "create",
					model: { data : text },
					options: null
				};
				crudr.sync(model.socket, req, { error: function(err){ console.log(err) }, success: function( response ){ 
						//console.log( response );
					} 
				});
				
			});
			
		}
		
		function loadData(){
			
				// sync with crudr
				var req = {
					method: "read", 
					model: {}
				};
				
				crudr.sync(model.socket, req, { error: function(err){ console.log(err) }, success: function( response ){ 
						//console.log( response );
					} 
				});
			
		}
		
        $(function() {
			chat = document.getElementById("chat");
            
			crudr.connect(auth, function( response ){
				
				//var message = new Message();
				
				model = crudr.subscribe({
							name: backend, 
							el: chat
					});
				
				setupEvents();
				
				setupTriggers();
				
				loadData();
				
			});
			
			
        });
    </script>
    
</head>
<body>
    <h1>Chat</h1>
    <ul id="chat"></ul>
    
    <input class="message" type="text">
    <input class="send" type="submit" value="Send">
    
</body>
</html>